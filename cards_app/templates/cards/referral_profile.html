{% extends "base_ok.html" %}
{% load static %}
{% block css %}
<link href="{% static 'cards/custom_card.css' %}" rel="stylesheet">
{% endblock css %}

{% block dynamic_content %}



{% if 'ПАЦІЄНТИ' in user_groups and not card.doctor %}
    {% include 'not_family_doc.html' %}
{% endif %}

  {% if card_referral %}
    {% if 'ПАЦІЄНТИ' in user_groups %}
        <h2 class="font-weight-bold text-center py-4">Мої направлення</h2>
    {% else %}
<div class="container py-4">
  <div class="row align-items-center">
    <div class="col text-center">
      <h3 class="font-weight-bold mb-0">
        Направлення: {{ card.patient.user.last_name }} {{ card.patient.user.first_name }}
        {% if card.patient.user.patronymic %} {{ card.patient.user.patronymic }}{% endif %}
      </h3>
    </div>
    {% if 'ЛІКАРІ' in user_groups %}
    <div class="col-auto">  
          <a class="btn btn-outline-primary px-4 mt-3 fw-semibold" href="{% url 'card:add_referral' card_id=card.display_id %}">
            <i class="bi bi-clipboard-plus"></i> Направлення
        </a>
    </div>{% endif %}
  </div>
</div>
    {% endif %}
    {% for ref in card_referral %}
      <div class="card mb-4 shadow border-0 rounded-4">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h4 class="font-weight-bold mb-0 text-dark">
              {% if ref.type_analys %}
                {{ ref.type_analys.name }}
              {% else %}
                <span class="text-muted fst-italic">Аналіз не вказано</span>
              {% endif %}
            </h4>
            <small class="text-muted fst-italic">
              Створено: {{ ref.creation_date|date:"d.m.Y H:i" }}
            </small>
          </div>

          <p class="card-text fs-5 mb-2">
            <strong class="text-secondary">Статус:</strong>
            {% with ref.resultanalysis as result %}
              {% if result %}
                <span class="badge bg-success text-white px-4 py-2 fs-6">Виконано</span>
                <small class="text-success ms-2">({{ result.providing_date|date:"d.m.Y" }})</small>
              {% elif ref.status == 'C' %}
                <span class="badge bg-secondary text-white px-4 py-2 fs-6">Анульовано</span>
              {% else %}
                <span class="badge bg-warning text-white px-4 py-2 fs-6">Активне</span>
              {% endif %}
            {% endwith %}
          </p>
          <p class="card-text fs-5 mb-0">
            <strong class="text-secondary">Виписав:</strong>
            {% if ref.doctor %}
              {{ ref.doctor.user.last_name }} {{ ref.doctor.user.first_name }}
              {% if ref.doctor.user.patronymic %}
                {{ ref.doctor.user.patronymic }}
              {% endif %}
              <small class="text-muted fst-italic">
                ({{ ref.doctor.specialization }})
              </small>
            {% else %}
              <span class="text-danger">Лікар не вказаний</span>
            {% endif %}
          </p>
          <div class="text-end mt-3">
            <button type="button"
                    class="btn btn-outline-primary px-4 py-2 rounded-pill fw-semibold"
                    data-bs-toggle="modal"
                    data-bs-target="#referralModal{{ ref.id }}">Більше інформації</button>
          </div>
        </div>
      </div>
      <div class="modal fade" id="referralModal{{ ref.id }}" tabindex="-1" aria-labelledby="referralModalLabel{{ ref.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="referralModalLabel{{ ref.display_id }}">Направлення №{{ ref.display_id }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрити"></button>
      </div>

      <div class="modal-body">
        <p><strong class="font-weight-bold">Тип аналізу:</strong> {{ ref.type_analys.name }}</p>
        {% if ref.type_analys.description %}
          <p><strong class="font-weight-bold">Опис аналізу:</strong> {{ ref.type_analys.description }}</p>
        {% endif %}
        
        <p><strong class="font-weight-bold">Дата створення:</strong> {{ ref.creation_date|date:"d.m.Y H:i" }}</p>
        <p><strong class="font-weight-bold">Лікар:</strong> {{ ref.doctor.user.last_name }} 
          {{ ref.doctor.user.first_name }}{% if ref.doctor.user.patronymic %}
                {{ ref.doctor.user.patronymic }}{% endif %}
              <span class="text-muted fst-italic">({{ ref.doctor.specialization }})</span>
        </p>
        <p><strong class="font-weight-bold">Статус:</strong>
          {% if ref.status == 'C' %}
            <span class="badge bg-secondary text-white px-4 py-2 fs-6">Анульовано</span>
          {% elif ref.resultanalysis %}
            <span class="badge bg-success text-white px-4 py-2 fs-6">Виконано</span>
            <span class="text-success ms-2">({{ ref.resultanalysis.providing_date|date:"d.m.Y" }})</span>
            <p><strong class="font-weight-bold">Лаборант:</strong> {{ ref.resultanalysis.lab_assistent.user.last_name }} {{ ref.resultanalysis.lab_assistent.user.first_name }}
{% if ref.resultanalysis.lab_assistent.user.patronymic %}{{ ref.resultanalysis.lab_assistent.user.patronymic }}{% endif %}</p>
          {% else %}
            <span class="badge bg-warning text-white px-4 py-2 fs-6">Активне</span>
          {% endif %}
        </p>
{% if not 'ПАЦІЄНТИ' in user_groups %}
{% if ref.coment %}
  <p><strong>Коментар:</strong> {{ ref.coment }}</p>
{% else %}
  <p><strong>Коментар:</strong> <span class="text-muted">Відсутній</span></p>
{% endif %}
        {% endif %} 

<div class="text-center mt-3">
    {% comment %} {% if ref.resultanalysis %}
        <a class="btn btn-outline-primary" href="#">
            <i class="bi bi-card-list"></i> Переглянути результат
        </a>
    {% endif %}
{% if not ref.resultanalysis %}
    {% if ref.doctor.user == user or ref.medcard.doctor.user == user%}
        <a class="btn btn-outline-primary"  href="{% url 'card:edit_referral' referral_id=ref.id %}">
            <i class="bi bi-pen"></i> Редагувати
        </a>
    {% endif %}
    {% endif %} {% endcomment %}


     {% if ref.resultanalysis %}
        <a class="btn btn-outline-primary" href="{% url 'card:result_id_profile' ref.resultanalysis.id %}"> 
            <i class="bi bi-card-list"></i> Переглянути результат
        </a>
{% else %}
    {% if ref.doctor.user == user or ref.medcard.doctor.user == user%}
        <a class="btn btn-outline-primary"  href="{% url 'card:edit_referral' referral_id=ref.id %}">
            <i class="bi bi-pen"></i> Редагувати
        </a>
    {% endif %}
    {% endif %} 
</div>

      </div>
    </div>
  </div>
</div>

    {% endfor %}





{% else %}
<div class="container mt-5">
    <h4 class="font-weight-bold mb-3 mt-4 text-center">
        Iнформація в медичній карті №{{card.display_id}} не знайдена!
    </h4>
    <p class="text-center">
        Дані в карту ще не занесені або медичних втручань пов'язаних з цим розділом ще не було.
    </p>
</div>
{% endif %}
</div>
{% endblock %}
